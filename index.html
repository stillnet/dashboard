<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morning Dashboard</title>

    <!-- PWA Meta Tags for Fullscreen App Experience -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dashboard">
    <meta name="application-name" content="Dashboard">
    <meta name="theme-color" content="#667eea">
    <meta name="msapplication-navbutton-color" content="#667eea">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Web App Manifest -->
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        /* Ensure background persists in fullscreen mode */
        html:fullscreen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body:fullscreen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* Fallback approach using JavaScript class */
        .fullscreen-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }

        html.fullscreen-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            height: calc(100vh - 40px);
        }

        .datetime-weather-panel {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .datetime-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .current-time {
            font-size: 1.8rem;
            font-weight: 300;
        }

        .current-date {
            font-size: 1rem;
            opacity: 0.8;
        }

        .current-temp {
            font-size: 1.8rem;
            font-weight: 300;
        }

        .weather-desc {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 2px;
        }

        .fullscreen-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            backdrop-filter: blur(10px);
            transition: background 0.3s;
            z-index: 1000;
        }

        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .fullscreen-btn:fullscreen {
            display: none;
        }

        .weather-section, .calendar-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
            opacity: 0.9;
        }

        .weather-current {
            text-align: center;
            margin-bottom: 25px;
            position: relative;
        }

        .today-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: -5px;
            text-align: left;
            position: absolute;
            top: -10px;
            left: 0;
        }

        .temperature {
            font-size: 4rem;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .weather-description {
            font-size: 1.3rem;
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .weather-details {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .weather-item {
            text-align: center;
        }


        .weather-forecast {
            margin-top: 20px;
        }

        .forecast-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .calendar-events {
            max-height: 500px;
            overflow-y: auto;
        }

        .event-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 4px solid #ffd700;
        }

        .event-time {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .event-title {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .event-location {
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            opacity: 0.7;
            font-style: italic;
        }

        .error {
            color: #ffcccb;
            text-align: center;
            font-size: 0.9rem;
        }

        .auth-button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            margin: 10px;
            transition: background-color 0.3s;
        }

        .auth-button:hover {
            background: #357ae8;
        }

        .auth-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .current-time {
                font-size: 1.5rem;
            }

            .temperature {
                font-size: 3rem;
            }
        }

        .weather-status-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            z-index: 1001;
            transition: all 0.3s ease;
        }

        .weather-status-indicator.empty {
            background: transparent;
        }

        .weather-status-indicator.success {
            background: rgba(144, 238, 144, 0.7);
            border-color: rgba(144, 238, 144, 0.9);
        }

        .weather-status-indicator.error {
            background: #FF6B6B;
            border-color: #FF4757;
        }

        .weather-status-indicator.loading {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.7);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.5;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.1);
            }
            100% {
                opacity: 0.5;
                transform: scale(1);
            }
        }

        #build-number {
            position: fixed;
            top: 7px;
            left: 30px;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.15);
            font-family: monospace;
            z-index: 1000;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="build-number">v04</div>
    <div class="weather-status-indicator" id="weather-status-indicator" onclick="showWeatherStatus()"></div>
    <button class="fullscreen-btn" onclick="toggleFullscreen()">⛶ Fullscreen</button>

    <div class="dashboard">
        <div class="weather-section">
            <div class="datetime-weather-panel">
                <div class="datetime-header">
                    <div>
                        <div class="current-time" id="current-time"></div>
                        <div class="current-date" id="current-date"></div>
                    </div>
                    <div>
                        <div class="current-temp" id="current-temp"></div>
                        <div class="weather-desc" id="weather-desc"></div>
                    </div>
                </div>
                <div class="weather-details" id="weather-details"></div>
            </div>
            <div id="weather-content">
                <div class="loading">Loading weather data...</div>
            </div>
        </div>

        <div class="calendar-section">
            <div id="calendar-content">
                <iframe
                    id="calendar-iframe"
                    src="https://calendar.google.com/calendar/u/0/embed?src=8mtboh1ko0c8d4j5e78j62b4g4@group.calendar.google.com&ctz=America/Chicago&mode=AGENDA&showTitle=0&showPrint=0&showTabs=0&showCalendars=0&showTz=0&height=800"
                    style="border: 0; width: 100%; height: calc(100vh - 60px); border-radius: 10px;"
                    frameborder="0"
                    scrolling="no"
                    onerror="handleCalendarError()">
                </iframe>
                <div id="calendar-fallback" style="display: none;">
                    <div class="loading" style="margin-bottom: 15px;">
                        Calendar authentication required
                    </div>
                    <a href="https://calendar.google.com/calendar/u/0?cid=8mtboh1ko0c8d4j5e78j62b4g4@group.calendar.google.com"
                       target="_blank"
                       class="auth-button">
                        Open Calendar in New Tab
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Weather status tracking
        let weatherStatus = 'empty'; // 'empty', 'loading', 'success', 'error'
        let lastWeatherFetch = null;
        let cachedWeatherData = null;

        // Update weather status indicator
        function updateWeatherStatusIndicator() {
            const indicator = document.getElementById('weather-status-indicator');
            if (indicator) {
                indicator.className = `weather-status-indicator ${weatherStatus}`;
            }
        }

        // Show weather status popup
        function showWeatherStatus() {
            let message;
            if (weatherStatus === 'empty') {
                message = 'No weather fetch attempted yet';
            } else if (weatherStatus === 'loading') {
                message = 'Weather fetch in progress...';
            } else if (lastWeatherFetch) {
                const timestamp = lastWeatherFetch.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }) + ' at ' + lastWeatherFetch.toLocaleTimeString('en-US');

                const statusText = weatherStatus === 'success' ? 'succeeded' : 'failed';
                message = `Last weather fetch at ${timestamp} ${statusText}`;
            } else {
                message = 'No weather fetch information available';
            }
            alert(message);
        }

        // Calendar error handling
        function handleCalendarError() {
            console.log('Calendar iframe failed to load, showing fallback...');
            document.getElementById('calendar-iframe').style.display = 'none';
            document.getElementById('calendar-fallback').style.display = 'block';
        }

        // Check if calendar loads properly after a delay
        setTimeout(() => {
            const iframe = document.getElementById('calendar-iframe');
            try {
                // Try to detect if iframe loaded successfully
                // Note: Due to CORS, we can't actually check iframe content
                // This is just a backup check in case of obvious failures
                if (!iframe.contentWindow) {
                    console.log('Calendar iframe may not have loaded properly');
                }
            } catch (e) {
                console.log('Calendar iframe cross-origin check (expected):', e.message);
            }
        }, 3000);

        // Weather Functions
        async function loadWeatherData() {
            // Set loading status
            weatherStatus = 'loading';
            lastWeatherFetch = new Date();
            updateWeatherStatusIndicator();

            try {
                // Get weather for Omaha, NE using Open-Meteo API
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=41.2524&longitude=-95.9980&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&temperature_unit=fahrenheit&wind_speed_unit=mph&daily=temperature_2m_max,temperature_2m_min,weather_code,precipitation_probability_max,precipitation_sum,wind_speed_10m_max,uv_index_max&forecast_days=7&timezone=America/Chicago');
                const weatherData = await response.json();

                // Success - cache the data and update status
                cachedWeatherData = weatherData;
                weatherStatus = 'success';
                updateWeatherStatusIndicator();
                displayWeatherData(weatherData);
            } catch (error) {
                console.error('Error loading weather data:', error);
                weatherStatus = 'error';
                updateWeatherStatusIndicator();

                // If we have cached data, display it instead of error message
                if (cachedWeatherData) {
                    displayWeatherData(cachedWeatherData);
                } else {
                    document.getElementById('weather-content').innerHTML = '<div class="error">Failed to load weather data</div>';
                }
            }
        }

        // Weather code to description mapping
        function getWeatherDescription(code) {
            const weatherCodes = {
                0: 'Clear sky',
                1: 'Mainly clear',
                2: 'Partly cloudy',
                3: 'Overcast',
                45: 'Foggy',
                48: 'Rime fog',
                51: 'Light drizzle',
                53: 'Moderate drizzle',
                55: 'Dense drizzle',
                56: 'Freezing drizzle',
                57: 'Dense freezing drizzle',
                61: 'Slight rain',
                63: 'Moderate rain',
                65: 'Heavy rain',
                66: 'Freezing rain',
                67: 'Heavy freezing rain',
                71: 'Slight snow',
                73: 'Moderate snow',
                75: 'Heavy snow',
                77: 'Snow grains',
                80: 'Rain showers',
                81: 'Moderate rain showers',
                82: 'Violent rain showers',
                85: 'Snow showers',
                86: 'Heavy snow showers',
                95: 'Thunderstorm',
                96: 'Thunderstorm with hail',
                99: 'Thunderstorm with heavy hail'
            };
            return weatherCodes[code] || 'Unknown';
        }

        function displayWeatherData(data) {
            const current = data.current;
            const daily = data.daily;

            // Today's detailed forecast (index 0)
            const todayHigh = Math.round(daily.temperature_2m_max[0]);
            const todayLow = Math.round(daily.temperature_2m_min[0]);
            const todayDesc = getWeatherDescription(daily.weather_code[0]);
            const precipChance = daily.precipitation_probability_max[0] || 0;
            const windMax = Math.round(daily.wind_speed_10m_max[0]);
            const uvIndex = Math.round(daily.uv_index_max[0]);
            const currentTemp = Math.round(current.temperature_2m);

            // Update header temperature and description
            document.getElementById('current-temp').textContent = `${currentTemp}°F`;
            document.getElementById('weather-desc').textContent = todayDesc;

            // Update compact details
            document.getElementById('weather-details').innerHTML = `
                <div class="weather-item">
                    <div>Rain</div>
                    <div>${precipChance}%</div>
                </div>
                <div class="weather-item">
                    <div>Wind</div>
                    <div>${windMax}mph</div>
                </div>
                <div class="weather-item">
                    <div>UV</div>
                    <div>${uvIndex}</div>
                </div>
                <div class="weather-item">
                    <div>Humidity</div>
                    <div>${current.relative_humidity_2m}%</div>
                </div>
            `;

            let weatherHtml = `
                <div class="weather-current">
                    <div class="today-label">Today</div>
                    <div class="temperature">${todayHigh}°/${todayLow}°F</div>
                    <div class="weather-description">${todayDesc}</div>
                </div>
            `;

            // Forecast starting from tomorrow (index 1 onwards)
            if (daily && daily.temperature_2m_max) {
                weatherHtml += '<div class="weather-forecast">';

                for (let i = 1; i < daily.time.length; i++) {
                    // Parse date in local time to avoid UTC timezone issues
                    const [year, month, day] = daily.time[i].split('-');
                    const date = new Date(year, month - 1, day);  // Month is 0-indexed
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });

                    const high = Math.round(daily.temperature_2m_max[i]);
                    const low = Math.round(daily.temperature_2m_min[i]);
                    const forecastDesc = getWeatherDescription(daily.weather_code[i]);
                    const rainChance = daily.precipitation_probability_max[i] || 0;

                    weatherHtml += `
                        <div class="forecast-item">
                            <div>${dayName}</div>
                            <div>${high}°/${low}°F</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">${forecastDesc}</div>
                            <div style="font-size: 0.7rem; opacity: 0.7;">${rainChance}% rain</div>
                        </div>
                    `;
                }
                weatherHtml += '</div>';
            }

            if (document.getElementById('weather-content')) {
                document.getElementById('weather-content').innerHTML = weatherHtml;
            }
        }

        // Time and Date Functions
        function updateTimeAndDate() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'});
            const dateString = now.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'numeric',
                day: 'numeric'
            });

            document.getElementById('current-time').textContent = timeString;
            document.getElementById('current-date').textContent = dateString;
        }

        // Wake Lock functionality to keep screen awake
        let wakeLock = null;

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake lock is active - screen will stay awake');

                    wakeLock.addEventListener('release', () => {
                        console.log('Wake lock was released');
                    });
                } else {
                    console.log('Wake Lock API not supported');
                }
            } catch (err) {
                console.error('Failed to request wake lock:', err);
            }
        }

        // Re-request wake lock when page becomes visible again
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
            }
        });

        // Fullscreen functionality
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.body.requestFullscreen().then(() => {
                    document.body.style.overflow = "auto";
                }).catch(err => {
                    console.error('Error attempting to enable fullscreen:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Function to check if we should hide the fullscreen button
        function updateFullscreenButtonVisibility() {
            const btn = document.querySelector('.fullscreen-btn');

            // Hide button if in fullscreen mode OR if running as PWA in standalone mode
            const isFullscreen = !!document.fullscreenElement;
            const isPWAStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                                  window.navigator.standalone === true;

            if (isFullscreen || isPWAStandalone) {
                btn.style.display = 'none';
            } else {
                btn.style.display = 'block';
            }
        }

        // Hide fullscreen button when in fullscreen mode and force background
        document.addEventListener('fullscreenchange', () => {
            const btn = document.querySelector('.fullscreen-btn');
            if (document.fullscreenElement) {
                // Force background to persist in fullscreen
                document.documentElement.classList.add('fullscreen-active');
                document.body.classList.add('fullscreen-active');
            } else {
                // Remove fullscreen background classes
                document.documentElement.classList.remove('fullscreen-active');
                document.body.classList.remove('fullscreen-active');
            }
            updateFullscreenButtonVisibility();
        });

        // Initialize everything
        document.addEventListener('DOMContentLoaded', async function() {
            updateTimeAndDate();
            setInterval(updateTimeAndDate, 1000);

            // Initialize weather status indicator
            updateWeatherStatusIndicator();

            loadWeatherData();
            setInterval(loadWeatherData, 5 * 60 * 1000); // Refresh every 5 minutes

            // Request wake lock to keep screen awake
            await requestWakeLock();

            // Check initial fullscreen button visibility (for PWA standalone mode)
            updateFullscreenButtonVisibility();

            // No calendar initialization needed - using embedded iframe
        });
    </script>
</body>
</html>